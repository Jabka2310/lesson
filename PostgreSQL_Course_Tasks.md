# Курс PostgreSQL для начинающих - Теория и Задачи

## Введение

PostgreSQL - это мощная объектно-реляционная система управления базами данных (СУБД) с открытым исходным кодом. PostgreSQL известна своей надежностью, функциональностью и соответствием стандартам SQL.

**Особенности PostgreSQL:**
- Полная поддержка стандарта SQL
- ACID-совместимость (надежность транзакций)
- Расширяемость (можно добавлять свои типы данных и функции)
- Кроссплатформенность
- Высокая производительность
- Поддержка JSON, массивов, полнотекстового поиска

**Что такое база данных:**
База данных - это организованная коллекция данных, хранящаяся в структурированном виде. Таблицы похожи на Excel-таблицы: строки (записи) и столбцы (поля).

**Основные понятия:**
- **Таблица** - структура для хранения данных (как лист в Excel)
- **Строка (запись)** - одна единица данных в таблице
- **Столбец (поле)** - один атрибут данных (например, имя, возраст)
- **Первичный ключ (PRIMARY KEY)** - уникальный идентификатор строки
- **Схема** - контейнер для объектов базы данных

**Подключение к базе данных:**
```bash
# Через командную строку
psql -U имя_пользователя -d имя_базы

# Или просто
psql
```

**Основные команды psql:**
- `\l` - список всех баз данных
- `\c имя_базы` - подключиться к базе данных
- `\dt` - список всех таблиц
- `\d имя_таблицы` - описание таблицы
- `\q` - выйти из psql
- `\?` - справка по командам

---

## Уровень 1: Основы SQL (SELECT, INSERT)

### Теория

**SQL (Structured Query Language)** - язык структурированных запросов для работы с базами данных.

**Основные типы команд SQL:**
- **DDL (Data Definition Language)** - создание и изменение структуры: CREATE, ALTER, DROP
- **DML (Data Manipulation Language)** - работа с данными: SELECT, INSERT, UPDATE, DELETE
- **DCL (Data Control Language)** - управление доступом: GRANT, REVOKE

**Создание базы данных:**
```sql
CREATE DATABASE название_базы;
```

**Создание таблицы:**
```sql
CREATE TABLE название_таблицы (
    поле1 тип_данных,
    поле2 тип_данных,
    ...
);
```

**Основные типы данных PostgreSQL:**
- `INTEGER` или `INT` - целые числа (-2147483648 до 2147483647)
- `BIGINT` - большие целые числа
- `VARCHAR(n)` - строка переменной длины (до n символов)
- `TEXT` - строка неограниченной длины
- `BOOLEAN` - логическое значение (TRUE, FALSE, NULL)
- `DATE` - дата (YYYY-MM-DD)
- `TIMESTAMP` - дата и время
- `DECIMAL(p, s)` или `NUMERIC` - точные десятичные числа
- `REAL` или `DOUBLE PRECISION` - числа с плавающей точкой

**Вставка данных (INSERT):**
```sql
INSERT INTO название_таблицы (поле1, поле2, ...) 
VALUES (значение1, значение2, ...);
```

**Выборка данных (SELECT):**
```sql
SELECT поле1, поле2, ... 
FROM название_таблицы;
```

**Выборка всех полей:**
```sql
SELECT * FROM название_таблицы;
```

**Пример создания таблицы:**
```sql
CREATE TABLE студенты (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50),
    возраст INTEGER,
    группа VARCHAR(10)
);
```

**Пример вставки данных:**
```sql
INSERT INTO студенты (id, имя, возраст, группа) 
VALUES (1, 'Никита', 20, 'ИТ-21');
```

**Пример выборки:**
```sql
SELECT * FROM студенты;
```

**Результат:**
```
 id |  имя   | возраст | группа
----+--------+---------+--------
  1 | Никита |      20 | ИТ-21
```

---

## Уровень 1: Задачи

### Задача 1.1
Создайте базу данных `университет`.

**Команда для выполнения:**
```sql
CREATE DATABASE университет;
```

**Проверка:**
```sql
\l
```

**Пример вывода:**
```
                              Список баз данных
    Имя     | Владелец | Кодировка | Локаль |  Правила доступа
------------+----------+-----------+--------+------------------
 университет | postgres | UTF8      | C      |
```

### Задача 1.2
Создайте таблицу `студенты` с полями:
- `id` (INTEGER, PRIMARY KEY)
- `имя` (VARCHAR(50))
- `возраст` (INTEGER)
- `город` (VARCHAR(50))

**Команда для выполнения:**
```sql
CREATE TABLE студенты (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50),
    возраст INTEGER,
    город VARCHAR(50)
);
```

**Проверка:**
```sql
\d студенты
```

**Пример вывода:**
```
                    Таблица "public.студенты"
 Столбец |         Тип          | Правило сортировки | Nullable | По умолчанию
---------+----------------------+--------------------+----------+-------------
 id      | integer              |                    | not null |
 имя     | character varying(50)|                    |          |
 возраст | integer              |                    |          |
 город   | character varying(50)|                    |          |
Индексы:
    "студенты_pkey" PRIMARY KEY, btree (id)
```

### Задача 1.3
Вставьте в таблицу `студенты` следующие данные:
- id=1, имя='Никита', возраст=20, город='Москва'
- id=2, имя='Мария', возраст=19, город='Санкт-Петербург'
- id=3, имя='Алексей', возраст=21, город='Москва'

**Команда для выполнения:**
```sql
INSERT INTO студенты (id, имя, возраст, город) VALUES
(1, 'Никита', 20, 'Москва'),
(2, 'Мария', 19, 'Санкт-Петербург'),
(3, 'Алексей', 21, 'Москва');
```

**Проверка:**
```sql
SELECT * FROM студенты;
```

**Пример вывода:**
```
 id |  имя    | возраст |      город
----+---------+---------+------------------
  1 | Никита  |      20 | Москва
  2 | Мария   |      19 | Санкт-Петербург
  3 | Алексей |      21 | Москва
```

### Задача 1.4
Выведите только имена и возраст всех студентов.

**Команда для выполнения:**
```sql
SELECT имя, возраст FROM студенты;
```

**Пример вывода:**
```
  имя    | возраст
---------+---------
 Никита  |      20
 Мария   |      19
 Алексей |      21
```

### Задача 1.5
Создайте таблицу `книги` с полями: `id` (INTEGER, PRIMARY KEY), `название` (VARCHAR(100)), `автор` (VARCHAR(50)), `год` (INTEGER). Вставьте 3 книги.

**Команда для выполнения:**
```sql
CREATE TABLE книги (
    id INTEGER PRIMARY KEY,
    название VARCHAR(100),
    автор VARCHAR(50),
    год INTEGER
);

INSERT INTO книги (id, название, автор, год) VALUES
(1, 'Война и мир', 'Толстой', 1869),
(2, 'Преступление и наказание', 'Достоевский', 1866),
(3, 'Анна Каренина', 'Толстой', 1877);
```

**Проверка:**
```sql
SELECT * FROM книги;
```

**Пример вывода:**
```
 id |        название         |    автор     | год
----+-------------------------+--------------+------
  1 | Война и мир             | Толстой      | 1869
  2 | Преступление и наказание| Достоевский  | 1866
  3 | Анна Каренина           | Толстой      | 1877
```

---

## Уровень 2: Условия (WHERE)

### Теория

**WHERE** - условие для фильтрации строк при выборке данных.

**Операторы сравнения:**
- `=` - равно
- `!=` или `<>` - не равно
- `>` - больше
- `<` - меньше
- `>=` - больше или равно
- `<=` - меньше или равно

**Логические операторы:**
- `AND` - И (оба условия должны быть true)
- `OR` - ИЛИ (хотя бы одно условие должно быть true)
- `NOT` - НЕ (инвертирует условие)

**Синтаксис:**
```sql
SELECT * FROM таблица
WHERE условие;
```

**Примеры:**
```sql
-- Студенты старше 20 лет
SELECT * FROM студенты WHERE возраст > 20;

-- Студенты из Москвы
SELECT * FROM студенты WHERE город = 'Москва';

-- Студенты старше 19 И из Москвы
SELECT * FROM студенты 
WHERE возраст > 19 AND город = 'Москва';

-- Студенты старше 20 ИЛИ из Санкт-Петербурга
SELECT * FROM студенты 
WHERE возраст > 20 OR город = 'Санкт-Петербург';
```

**Операторы для работы с NULL:**
- `IS NULL` - значение равно NULL
- `IS NOT NULL` - значение не равно NULL

**Оператор IN:**
```sql
-- Студенты из Москвы или Санкт-Петербурга
SELECT * FROM студенты 
WHERE город IN ('Москва', 'Санкт-Петербург');
```

**Оператор BETWEEN:**
```sql
-- Студенты в возрасте от 19 до 21
SELECT * FROM студенты 
WHERE возраст BETWEEN 19 AND 21;
```

**Оператор LIKE (поиск по шаблону):**
- `%` - любое количество символов
- `_` - один символ

```sql
-- Имена, начинающиеся с "Н"
SELECT * FROM студенты WHERE имя LIKE 'Н%';

-- Имена, содержащие "ик"
SELECT * FROM студенты WHERE имя LIKE '%ик%';
```

---

## Уровень 2: Задачи

### Задача 2.1
Выведите всех студентов старше 20 лет.

**Команда для выполнения:**
```sql
SELECT * FROM студенты WHERE возраст > 20;
```

**Пример вывода:**
```
 id |  имя    | возраст | город
----+---------+---------+-------
  3 | Алексей |      21 | Москва
```

### Задача 2.2
Выведите всех студентов из Москвы.

**Команда для выполнения:**
```sql
SELECT * FROM студенты WHERE город = 'Москва';
```

**Пример вывода:**
```
 id |  имя    | возраст | город
----+---------+---------+-------
  1 | Никита  |      20 | Москва
  3 | Алексей |      21 | Москва
```

### Задача 2.3
Выведите студентов, которые старше 19 лет И из Москвы.

**Команда для выполнения:**
```sql
SELECT * FROM студенты 
WHERE возраст > 19 AND город = 'Москва';
```

**Пример вывода:**
```
 id |  имя    | возраст | город
----+---------+---------+-------
  1 | Никита  |      20 | Москва
  3 | Алексей |      21 | Москва
```

### Задача 2.4
Выведите книги, изданные после 1870 года.

**Команда для выполнения:**
```sql
SELECT * FROM книги WHERE год > 1870;
```

**Пример вывода:**
```
 id |   название    |  автор  | год
----+---------------+---------+------
  1 | Война и мир   | Толстой | 1869
  3 | Анна Каренина | Толстой | 1877
```

**Примечание:** В примере показан неправильный результат. Правильный результат:
```
 id |   название    |  автор  | год
----+---------------+---------+------
  3 | Анна Каренина | Толстой | 1877
```

### Задача 2.5
Выведите книги автора "Толстой".

**Команда для выполнения:**
```sql
SELECT * FROM книги WHERE автор = 'Толстой';
```

**Пример вывода:**
```
 id |   название    |  автор  | год
----+---------------+---------+------
  1 | Война и мир   | Толстой | 1869
  3 | Анна Каренина | Толстой | 1877
```

---

## Уровень 3: Сортировка и ограничение (ORDER BY, LIMIT)

### Теория

**ORDER BY** - сортировка результатов запроса.

**Синтаксис:**
```sql
SELECT * FROM таблица
ORDER BY поле [ASC|DESC];
```

- `ASC` - по возрастанию (по умолчанию)
- `DESC` - по убыванию

**Сортировка по нескольким полям:**
```sql
SELECT * FROM студенты
ORDER BY город ASC, возраст DESC;
```

**LIMIT** - ограничение количества возвращаемых строк.

**Синтаксис:**
```sql
SELECT * FROM таблица
LIMIT количество;
```

**OFFSET** - пропуск определенного количества строк.

**Синтаксис:**
```sql
SELECT * FROM таблица
LIMIT количество OFFSET пропустить;
```

**Примеры:**
```sql
-- Студенты, отсортированные по возрасту (по возрастанию)
SELECT * FROM студенты ORDER BY возраст;

-- Студенты, отсортированные по возрасту (по убыванию)
SELECT * FROM студенты ORDER BY возраст DESC;

-- Три самых старших студента
SELECT * FROM студенты ORDER BY возраст DESC LIMIT 3;

-- Второй и третий студент (пропустить 1, взять 2)
SELECT * FROM студенты ORDER BY id LIMIT 2 OFFSET 1;
```

---

## Уровень 3: Задачи

### Задача 3.1
Выведите всех студентов, отсортированных по возрасту (по возрастанию).

**Команда для выполнения:**
```sql
SELECT * FROM студенты ORDER BY возраст;
```

**Пример вывода:**
```
 id |  имя    | возраст |      город
----+---------+---------+------------------
  2 | Мария   |      19 | Санкт-Петербург
  1 | Никита  |      20 | Москва
  3 | Алексей |      21 | Москва
```

### Задача 3.2
Выведите всех студентов, отсортированных по имени (по алфавиту).

**Команда для выполнения:**
```sql
SELECT * FROM студенты ORDER BY имя;
```

**Пример вывода:**
```
 id |  имя    | возраст |      город
----+---------+---------+------------------
  3 | Алексей |      21 | Москва
  2 | Мария   |      19 | Санкт-Петербург
  1 | Никита  |      20 | Москва
```

### Задача 3.3
Выведите самого старшего студента.

**Команда для выполнения:**
```sql
SELECT * FROM студенты ORDER BY возраст DESC LIMIT 1;
```

**Пример вывода:**
```
 id |  имя    | возраст | город
----+---------+---------+-------
  3 | Алексей |      21 | Москва
```

### Задача 3.4
Выведите книги, отсортированные по году издания (от новых к старым).

**Команда для выполнения:**
```sql
SELECT * FROM книги ORDER BY год DESC;
```

**Пример вывода:**
```
 id |        название         |    автор     | year
----+-------------------------+--------------+------
  3 | Анна Каренина           | Толстой      | 1877
  1 | Война и мир             | Толстой      | 1869
  2 | Преступление и наказание| Достоевский  | 1866
```

### Задача 3.5
Выведите студентов, отсортированных сначала по городу, затем по возрасту (по убыванию).

**Команда для выполнения:**
```sql
SELECT * FROM студенты ORDER BY город, возраст DESC;
```

**Пример вывода:**
```
 id |  имя    | возраст |      город
----+---------+---------+------------------
  1 | Никита  |      20 | Москва
  3 | Алексей |      21 | Москва
  2 | Мария   |      19 | Санкт-Петербург
```

---

## Уровень 4: Агрегатные функции

### Теория

**Агрегатные функции** - функции, которые выполняют вычисления над набором строк и возвращают одно значение.

**Основные агрегатные функции:**
- `COUNT()` - количество строк
- `SUM()` - сумма значений
- `AVG()` - среднее значение
- `MAX()` - максимальное значение
- `MIN()` - минимальное значение

**Примеры:**
```sql
-- Количество студентов
SELECT COUNT(*) FROM студенты;

-- Средний возраст студентов
SELECT AVG(возраст) FROM студенты;

-- Максимальный возраст
SELECT MAX(возраст) FROM студенты;

-- Минимальный возраст
SELECT MIN(возраст) FROM студенты;

-- Сумма возрастов (пример)
SELECT SUM(возраст) FROM студенты;
```

**Использование с WHERE:**
```sql
-- Количество студентов из Москвы
SELECT COUNT(*) FROM студенты WHERE город = 'Москва';

-- Средний возраст студентов старше 19
SELECT AVG(возраст) FROM студенты WHERE возраст > 19;
```

**Алиасы (псевдонимы) для столбцов:**
```sql
SELECT 
    COUNT(*) AS количество,
    AVG(возраст) AS средний_возраст,
    MAX(возраст) AS максимальный_возраст
FROM студенты;
```

---

## Уровень 4: Задачи

### Задача 4.1
Выведите общее количество студентов.

**Команда для выполнения:**
```sql
SELECT COUNT(*) FROM студенты;
```

**Пример вывода:**
```
 count
-------
     3
```

### Задача 4.2
Выведите средний возраст студентов.

**Команда для выполнения:**
```sql
SELECT AVG(возраст) FROM студенты;
```

**Пример вывода:**
```
        avg
-------------------
 20.0000000000000000
```

### Задача 4.3
Выведите максимальный и минимальный возраст студентов.

**Команда для выполнения:**
```sql
SELECT MAX(возраст) AS максимальный, MIN(возраст) AS минимальный 
FROM студенты;
```

**Пример вывода:**
```
 максимальный | минимальный
--------------+-------------
           21 |          19
```

### Задача 4.4
Выведите количество студентов из Москвы.

**Команда для выполнения:**
```sql
SELECT COUNT(*) FROM студенты WHERE город = 'Москва';
```

**Пример вывода:**
```
 count
-------
     2
```

### Задача 4.5
Выведите средний год издания книг.

**Команда для выполнения:**
```sql
SELECT AVG(год) FROM книги;
```

**Пример вывода:**
```
        avg
-------------------
 1870.6666666666666667
```

---

## Уровень 5: Группировка (GROUP BY)

### Теория

**GROUP BY** - группировка строк по значениям одного или нескольких столбцов.

**Синтаксис:**
```sql
SELECT поле1, агрегатная_функция(поле2)
FROM таблица
GROUP BY поле1;
```

**Важно:** В SELECT можно использовать только поля из GROUP BY и агрегатные функции.

**Примеры:**
```sql
-- Количество студентов в каждом городе
SELECT город, COUNT(*) AS количество
FROM студенты
GROUP BY город;

-- Средний возраст студентов в каждом городе
SELECT город, AVG(возраст) AS средний_возраст
FROM студенты
GROUP BY город;

-- Количество книг каждого автора
SELECT автор, COUNT(*) AS количество_книг
FROM книги
GROUP BY автор;
```

**HAVING** - условие для групп (аналог WHERE, но для GROUP BY).

```sql
-- Города, где больше 1 студента
SELECT город, COUNT(*) AS количество
FROM студенты
GROUP BY город
HAVING COUNT(*) > 1;
```

**Разница между WHERE и HAVING:**
- `WHERE` - фильтрует строки ДО группировки
- `HAVING` - фильтрует группы ПОСЛЕ группировки

---

## Уровень 5: Задачи

### Задача 5.1
Выведите количество студентов в каждом городе.

**Команда для выполнения:**
```sql
SELECT город, COUNT(*) AS количество
FROM студенты
GROUP BY город;
```

**Пример вывода:**
```
      город       | количество
------------------+------------
 Москва           |          2
 Санкт-Петербург  |          1
```

### Задача 5.2
Выведите средний возраст студентов в каждом городе.

**Команда для выполнения:**
```sql
SELECT город, AVG(возраст) AS средний_возраст
FROM студенты
GROUP BY город;
```

**Пример вывода:**
```
      город       |   средний_возраст
------------------+--------------------
 Москва           | 20.5000000000000000
 Санкт-Петербург  | 19.0000000000000000
```

### Задача 5.3
Выведите количество книг каждого автора.

**Команда для выполнения:**
```sql
SELECT автор, COUNT(*) AS количество_книг
FROM книги
GROUP BY автор;
```

**Пример вывода:**
```
    автор     | количество_книг
--------------+-----------------
 Толстой      |               2
 Достоевский  |               1
```

### Задача 5.4
Выведите города, где учится больше 1 студента.

**Команда для выполнения:**
```sql
SELECT город, COUNT(*) AS количество
FROM студенты
GROUP BY город
HAVING COUNT(*) > 1;
```

**Пример вывода:**
```
 город  | количество
--------+------------
 Москва |          2
```

### Задача 5.5
Выведите авторов, у которых больше 1 книги.

**Команда для выполнения:**
```sql
SELECT автор, COUNT(*) AS количество
FROM книги
GROUP BY автор
HAVING COUNT(*) > 1;
```

**Пример вывода:**
```
  автор  | количество
---------+------------
 Толстой |          2
```

---

## Уровень 6: Обновление и удаление (UPDATE, DELETE)

### Теория

**UPDATE** - обновление существующих данных в таблице.

**Синтаксис:**
```sql
UPDATE таблица
SET поле1 = значение1, поле2 = значение2, ...
WHERE условие;
```

**Важно:** Без WHERE обновятся ВСЕ строки!

**Примеры:**
```sql
-- Изменить возраст студента с id=1
UPDATE студенты
SET возраст = 21
WHERE id = 1;

-- Изменить город для всех студентов из Москвы
UPDATE студенты
SET город = 'Москва_новая'
WHERE город = 'Москва';

-- Изменить несколько полей
UPDATE студенты
SET возраст = 22, город = 'Казань'
WHERE id = 3;
```

**DELETE** - удаление данных из таблицы.

**Синтаксис:**
```sql
DELETE FROM таблица
WHERE условие;
```

**Важно:** Без WHERE удалятся ВСЕ строки!

**Примеры:**
```sql
-- Удалить студента с id=3
DELETE FROM студенты WHERE id = 3;

-- Удалить всех студентов старше 25
DELETE FROM студенты WHERE возраст > 25;

-- Удалить все записи (осторожно!)
DELETE FROM студенты;
```

**TRUNCATE** - быстрое удаление всех строк из таблицы.

```sql
TRUNCATE TABLE студенты;
```

---

## Уровень 6: Задачи

### Задача 6.1
Измените возраст студента с id=1 на 21.

**Команда для выполнения:**
```sql
UPDATE студенты SET возраст = 21 WHERE id = 1;
```

**Проверка:**
```sql
SELECT * FROM студенты WHERE id = 1;
```

**Пример вывода:**
```
 id |  имя   | возраст | город
----+--------+---------+-------
  1 | Никита |      21 | Москва
```

### Задача 6.2
Измените город студента с id=2 на 'Казань'.

**Команда для выполнения:**
```sql
UPDATE студенты SET город = 'Казань' WHERE id = 2;
```

**Проверка:**
```sql
SELECT * FROM студенты WHERE id = 2;
```

**Пример вывода:**
```
 id |  имя  | возраст | город
----+-------+---------+--------
  2 | Мария |      19 | Казань
```

### Задача 6.3
Увеличьте возраст всех студентов на 1 год.

**Команда для выполнения:**
```sql
UPDATE студенты SET возраст = возраст + 1;
```

**Проверка:**
```sql
SELECT * FROM студенты;
```

**Пример вывода:**
```
 id |  имя    | возраст |      город
----+---------+---------+------------------
  1 | Никита  |      21 | Москва
  2 | Мария   |      20 | Санкт-Петербург
  3 | Алексей |      22 | Москва
```

### Задача 6.4
Удалите студента с id=3.

**Команда для выполнения:**
```sql
DELETE FROM студенты WHERE id = 3;
```

**Проверка:**
```sql
SELECT * FROM студенты;
```

**Пример вывода:**
```
 id |  имя   | возраст |      город
----+--------+---------+------------------
  1 | Никита |      20 | Москва
  2 | Мария  |      19 | Санкт-Петербург
```

### Задача 6.5
Удалите всех студентов младше 20 лет.

**Команда для выполнения:**
```sql
DELETE FROM студенты WHERE возраст < 20;
```

**Проверка:**
```sql
SELECT * FROM студенты;
```

**Пример вывода:**
```
 id |  имя   | возраст | город
----+--------+---------+-------
  1 | Никита |      20 | Москва
  3 | Алексей|      21 | Москва
```

---

## Уровень 7: Объединения таблиц (JOIN)

### Теория

**JOIN** - объединение данных из нескольких таблиц.

**Типы JOIN:**
- **INNER JOIN** - только совпадающие строки
- **LEFT JOIN** - все строки из левой таблицы + совпадающие из правой
- **RIGHT JOIN** - все строки из правой таблицы + совпадающие из левой
- **FULL OUTER JOIN** - все строки из обеих таблиц

**Синтаксис:**
```sql
SELECT поля
FROM таблица1
[тип] JOIN таблица2 ON условие;
```

**Пример структуры:**
```sql
-- Создание связанных таблиц
CREATE TABLE группы (
    id INTEGER PRIMARY KEY,
    название VARCHAR(10),
    куратор VARCHAR(50)
);

CREATE TABLE студенты (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50),
    группа_id INTEGER REFERENCES группы(id)
);
```

**INNER JOIN:**
```sql
-- Студенты с информацией о группах
SELECT студенты.имя, группы.название
FROM студенты
INNER JOIN группы ON студенты.группа_id = группы.id;
```

**LEFT JOIN:**
```sql
-- Все студенты, даже если группа не указана
SELECT студенты.имя, группы.название
FROM студенты
LEFT JOIN группы ON студенты.группа_id = группы.id;
```

**Алиасы таблиц:**
```sql
SELECT s.имя, g.название
FROM студенты s
JOIN группы g ON s.группа_id = g.id;
```

---

## Уровень 7: Задачи

### Задача 7.1
Создайте таблицы `группы` и `студенты` со связью между ними.

**Команда для выполнения:**
```sql
CREATE TABLE группы (
    id INTEGER PRIMARY KEY,
    название VARCHAR(10),
    куратор VARCHAR(50)
);

CREATE TABLE студенты (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50),
    группа_id INTEGER REFERENCES группы(id)
);

INSERT INTO группы VALUES
(1, 'ИТ-21', 'Иванов'),
(2, 'ИТ-22', 'Петрова');

INSERT INTO студенты VALUES
(1, 'Никита', 1),
(2, 'Мария', 2),
(3, 'Алексей', 1);
```

### Задача 7.2
Выведите имена студентов и названия их групп.

**Команда для выполнения:**
```sql
SELECT студенты.имя, группы.название
FROM студенты
INNER JOIN группы ON студенты.группа_id = группы.id;
```

**Пример вывода:**
```
  имя    | название
---------+----------
 Никита  | ИТ-21
 Мария   | ИТ-22
 Алексей | ИТ-21
```

### Задача 7.3
Выведите всех студентов с информацией о группах (используйте LEFT JOIN).

**Команда для выполнения:**
```sql
SELECT студенты.имя, группы.название
FROM студенты
LEFT JOIN группы ON студенты.группа_id = группы.id;
```

**Пример вывода:**
```
  имя    | название
---------+----------
 Никита  | ИТ-21
 Мария   | ИТ-22
 Алексей | ИТ-21
```

### Задача 7.4
Выведите количество студентов в каждой группе.

**Команда для выполнения:**
```sql
SELECT группы.название, COUNT(студенты.id) AS количество
FROM группы
LEFT JOIN студенты ON группы.id = студенты.группа_id
GROUP BY группы.id, группы.название;
```

**Пример вывода:**
```
 название | количество
----------+------------
 ИТ-21    |          2
 ИТ-22    |          1
```

### Задача 7.5
Выведите студентов группы 'ИТ-21' с именем куратора.

**Команда для выполнения:**
```sql
SELECT студенты.имя, группы.куратор
FROM студенты
JOIN группы ON студенты.группа_id = группы.id
WHERE группы.название = 'ИТ-21';
```

**Пример вывода:**
```
  имя    | куратор
---------+---------
 Никита  | Иванов
 Алексей | Иванов
```

---

## Уровень 8: Подзапросы (Subqueries)

### Теория

**Подзапрос** - запрос внутри другого запроса.

**Типы подзапросов:**
- В SELECT
- В FROM
- В WHERE
- В HAVING

**Примеры:**
```sql
-- Студенты старше среднего возраста
SELECT * FROM студенты
WHERE возраст > (SELECT AVG(возраст) FROM студенты);

-- Студенты из группы с максимальным количеством студентов
SELECT * FROM студенты
WHERE группа_id = (
    SELECT группа_id 
    FROM студенты 
    GROUP BY группа_id 
    ORDER BY COUNT(*) DESC 
    LIMIT 1
);

-- Подзапрос в SELECT
SELECT 
    имя,
    возраст,
    (SELECT AVG(возраст) FROM студенты) AS средний_возраст
FROM студенты;
```

**EXISTS** - проверка существования строк.

```sql
-- Группы, в которых есть студенты
SELECT * FROM группы
WHERE EXISTS (
    SELECT 1 FROM студенты 
    WHERE студенты.группа_id = группы.id
);
```

**IN с подзапросом:**
```sql
-- Студенты из групп с куратором 'Иванов'
SELECT * FROM студенты
WHERE группа_id IN (
    SELECT id FROM группы WHERE куратор = 'Иванов'
);
```

---

## Уровень 8: Задачи

### Задача 8.1
Выведите студентов старше среднего возраста.

**Команда для выполнения:**
```sql
SELECT * FROM студенты
WHERE возраст > (SELECT AVG(возраст) FROM студенты);
```

**Пример вывода:**
```
 id |  имя    | возраст | группа_id
----+---------+---------+-----------
  3 | Алексей |      21 |         1
```

### Задача 8.2
Выведите студента с максимальным возрастом.

**Команда для выполнения:**
```sql
SELECT * FROM студенты
WHERE возраст = (SELECT MAX(возраст) FROM студенты);
```

**Пример вывода:**
```
 id |  имя    | возраст | группа_id
----+---------+---------+-----------
  3 | Алексей |      21 |         1
```

### Задача 8.3
Выведите студентов из группы с максимальным количеством студентов.

**Команда для выполнения:**
```sql
SELECT * FROM студенты
WHERE группа_id = (
    SELECT группа_id 
    FROM студенты 
    GROUP BY группа_id 
    ORDER BY COUNT(*) DESC 
    LIMIT 1
);
```

**Пример вывода:**
```
 id |  имя    | возраст | группа_id
----+---------+---------+-----------
  1 | Никита  |      20 |         1
  3 | Алексей |      21 |         1
```

### Задача 8.4
Выведите группы, в которых есть студенты.

**Команда для выполнения:**
```sql
SELECT * FROM группы
WHERE id IN (SELECT DISTINCT группа_id FROM студенты);
```

**Пример вывода:**
```
 id | название | куратор
----+----------+---------
  1 | ИТ-21    | Иванов
  2 | ИТ-22    | Петрова
```

### Задача 8.5
Выведите для каждого студента его возраст и средний возраст всех студентов.

**Команда для выполнения:**
```sql
SELECT 
    имя,
    возраст,
    (SELECT AVG(возраст) FROM студенты) AS средний_возраст
FROM студенты;
```

**Пример вывода:**
```
  имя    | возраст | средний_возраст
---------+---------+-----------------
 Никита  |      20 | 20.0000000000000000
 Мария   |      19 | 20.0000000000000000
 Алексей |      21 | 20.0000000000000000
```

---

## Уровень 9: Индексы и производительность

### Теория

**Индекс** - структура данных, ускоряющая поиск в таблице.

**Создание индекса:**
```sql
CREATE INDEX имя_индекса ON таблица (поле);
```

**Уникальный индекс:**
```sql
CREATE UNIQUE INDEX имя_индекса ON таблица (поле);
```

**Составной индекс:**
```sql
CREATE INDEX имя_индекса ON таблица (поле1, поле2);
```

**Удаление индекса:**
```sql
DROP INDEX имя_индекса;
```

**Просмотр индексов:**
```sql
\d таблица  -- показывает индексы таблицы
\di         -- список всех индексов
```

**Когда использовать индексы:**
- ✅ Частые поиски по полю
- ✅ Сортировка по полю
- ✅ JOIN по полю
- ❌ Маленькие таблицы (< 1000 строк)
- ❌ Частые обновления (замедляют INSERT/UPDATE)

**EXPLAIN** - анализ плана выполнения запроса.

```sql
EXPLAIN SELECT * FROM студенты WHERE город = 'Москва';
```

---

## Уровень 9: Задачи

### Задача 9.1
Создайте индекс на поле `город` в таблице `студенты`.

**Команда для выполнения:**
```sql
CREATE INDEX idx_город ON студенты (город);
```

**Проверка:**
```sql
\d студенты
```

**Пример вывода:**
```
                    Таблица "public.студенты"
 Столбец |         Тип          | Nullable | По умолчанию
---------+----------------------+----------+-------------
 id      | integer              | not null |
 имя     | character varying(50)|          |
 город   | character varying(50)|          |
Индексы:
    "студенты_pkey" PRIMARY KEY, btree (id)
    "idx_город" btree (город)
```

### Задача 9.2
Создайте индекс на поле `автор` в таблице `книги`.

**Команда для выполнения:**
```sql
CREATE INDEX idx_автор ON книги (автор);
```

### Задача 9.3
Создайте составной индекс на поля `город` и `возраст` в таблице `студенты`.

**Команда для выполнения:**
```sql
CREATE INDEX idx_город_возраст ON студенты (город, возраст);
```

### Задача 9.4
Проанализируйте план выполнения запроса поиска студентов по городу.

**Команда для выполнения:**
```sql
EXPLAIN SELECT * FROM студенты WHERE город = 'Москва';
```

**Пример вывода:**
```
                              QUERY PLAN
-------------------------------------------------------------------
 Index Scan using idx_город on студенты  (cost=0.14..8.16 rows=1 width=...)
   Index Cond: (город = 'Москва'::text)
```

### Задача 9.5
Удалите индекс `idx_город`.

**Команда для выполнения:**
```sql
DROP INDEX idx_город;
```

---

## Уровень 10: Транзакции

### Теория

**Транзакция** - последовательность операций, выполняемых как единое целое.

**Свойства транзакций (ACID):**
- **Atomicity (Атомарность)** - все или ничего
- **Consistency (Согласованность)** - данные остаются корректными
- **Isolation (Изолированность)** - транзакции не мешают друг другу
- **Durability (Долговечность)** - изменения сохраняются

**Управление транзакциями:**
```sql
BEGIN;          -- начало транзакции
-- операции
COMMIT;         -- подтверждение изменений
ROLLBACK;       -- отмена изменений
```

**Пример:**
```sql
BEGIN;
INSERT INTO студенты VALUES (4, 'Петр', 22, 1);
UPDATE студенты SET возраст = 23 WHERE id = 1;
-- Если все хорошо:
COMMIT;
-- Если ошибка:
ROLLBACK;
```

**SAVEPOINT** - точка сохранения внутри транзакции.

```sql
BEGIN;
INSERT INTO студенты VALUES (4, 'Петр', 22, 1);
SAVEPOINT sp1;
UPDATE студенты SET возраст = 25 WHERE id = 1;
-- Откат к точке сохранения
ROLLBACK TO SAVEPOINT sp1;
COMMIT;
```

---

## Уровень 10: Задачи

### Задача 10.1
Создайте транзакцию, которая добавляет нового студента и обновляет возраст существующего.

**Команда для выполнения:**
```sql
BEGIN;
INSERT INTO студенты VALUES (4, 'Петр', 22, 1);
UPDATE студенты SET возраст = 23 WHERE id = 1;
COMMIT;
```

**Проверка:**
```sql
SELECT * FROM студенты;
```

### Задача 10.2
Создайте транзакцию и откатите её (ROLLBACK).

**Команда для выполнения:**
```sql
BEGIN;
INSERT INTO студенты VALUES (5, 'Иван', 20, 2);
SELECT * FROM студенты;  -- видим новую запись
ROLLBACK;
SELECT * FROM студенты;  -- запись исчезла
```

### Задача 10.3
Используйте SAVEPOINT для создания точки сохранения.

**Команда для выполнения:**
```sql
BEGIN;
INSERT INTO студенты VALUES (5, 'Иван', 20, 2);
SAVEPOINT sp1;
UPDATE студенты SET возраст = 25 WHERE id = 5;
ROLLBACK TO SAVEPOINT sp1;  -- откат только UPDATE
COMMIT;  -- INSERT останется
```

---

## Уровень 11: Ограничения (Constraints)

### Теория

**Ограничения** - правила для обеспечения целостности данных.

**Типы ограничений:**
- **PRIMARY KEY** - первичный ключ (уникальный, не NULL)
- **FOREIGN KEY** - внешний ключ (связь с другой таблицей)
- **UNIQUE** - уникальное значение
- **NOT NULL** - значение не может быть NULL
- **CHECK** - проверка условия
- **DEFAULT** - значение по умолчанию

**Примеры:**
```sql
CREATE TABLE студенты (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50) NOT NULL,
    возраст INTEGER CHECK (возраст > 0 AND возраст < 150),
    email VARCHAR(100) UNIQUE,
    группа_id INTEGER REFERENCES группы(id),
    дата_поступления DATE DEFAULT CURRENT_DATE
);
```

**Добавление ограничений к существующей таблице:**
```sql
ALTER TABLE студенты 
ADD CONSTRAINT check_возраст 
CHECK (возраст > 0 AND возраст < 150);
```

**Удаление ограничения:**
```sql
ALTER TABLE студенты DROP CONSTRAINT check_возраст;
```

---

## Уровень 11: Задачи

### Задача 11.1
Создайте таблицу с ограничениями: PRIMARY KEY, NOT NULL, CHECK.

**Команда для выполнения:**
```sql
CREATE TABLE сотрудники (
    id INTEGER PRIMARY KEY,
    имя VARCHAR(50) NOT NULL,
    возраст INTEGER CHECK (возраст >= 18 AND возраст <= 65),
    зарплата DECIMAL(10,2) CHECK (зарплата > 0)
);
```

### Задача 11.2
Добавьте ограничение UNIQUE на поле email в таблице студенты.

**Команда для выполнения:**
```sql
ALTER TABLE студенты ADD COLUMN email VARCHAR(100);
ALTER TABLE студенты ADD CONSTRAINT unique_email UNIQUE (email);
```

### Задача 11.3
Добавьте ограничение CHECK на возраст (от 16 до 100).

**Команда для выполнения:**
```sql
ALTER TABLE студенты 
ADD CONSTRAINT check_возраст 
CHECK (возраст >= 16 AND возраст <= 100);
```

### Задача 11.4
Добавьте значение по умолчанию для поля дата_поступления.

**Команда для выполнения:**
```sql
ALTER TABLE студенты 
ADD COLUMN дата_поступления DATE DEFAULT CURRENT_DATE;
```

### Задача 11.5
Попробуйте вставить некорректные данные и убедитесь, что ограничения работают.

**Команда для выполнения:**
```sql
-- Должна быть ошибка
INSERT INTO студенты (id, имя, возраст) VALUES (10, 'Тест', 200);
```

---

## Уровень 12: Представления (Views)

### Теория

**Представление (View)** - виртуальная таблица, основанная на результате запроса.

**Создание представления:**
```sql
CREATE VIEW имя_представления AS
SELECT поля FROM таблицы WHERE условие;
```

**Использование:**
```sql
SELECT * FROM имя_представления;
```

**Обновляемое представление:**
```sql
CREATE VIEW студенты_москвы AS
SELECT * FROM студенты WHERE город = 'Москва';
```

**Удаление представления:**
```sql
DROP VIEW имя_представления;
```

**Преимущества:**
- Упрощение сложных запросов
- Безопасность (скрытие части данных)
- Абстракция данных

---

## Уровень 12: Задачи

### Задача 12.1
Создайте представление для студентов из Москвы.

**Команда для выполнения:**
```sql
CREATE VIEW студенты_москвы AS
SELECT * FROM студенты WHERE город = 'Москва';
```

**Использование:**
```sql
SELECT * FROM студенты_москвы;
```

### Задача 12.2
Создайте представление с именами студентов и названиями групп.

**Команда для выполнения:**
```sql
CREATE VIEW студенты_с_группами AS
SELECT s.имя, g.название AS группа
FROM студенты s
JOIN группы g ON s.группа_id = g.id;
```

### Задача 12.3
Создайте представление со статистикой по группам.

**Команда для выполнения:**
```sql
CREATE VIEW статистика_групп AS
SELECT 
    g.название,
    COUNT(s.id) AS количество_студентов,
    AVG(s.возраст) AS средний_возраст
FROM группы g
LEFT JOIN студенты s ON g.id = s.группа_id
GROUP BY g.id, g.название;
```

---

## Уровень 13: Функции и процедуры

### Теория

**Функция** - блок кода, возвращающий значение.

**Создание функции:**
```sql
CREATE OR REPLACE FUNCTION имя_функции(параметры)
RETURNS тип_возврата AS $$
BEGIN
    -- код
    RETURN значение;
END;
$$ LANGUAGE plpgsql;
```

**Процедура** - блок кода, не возвращающий значение (PostgreSQL 11+).

```sql
CREATE OR REPLACE PROCEDURE имя_процедуры(параметры)
AS $$
BEGIN
    -- код
END;
$$ LANGUAGE plpgsql;
```

**Пример функции:**
```sql
CREATE OR REPLACE FUNCTION средний_возраст()
RETURNS NUMERIC AS $$
BEGIN
    RETURN (SELECT AVG(возраст) FROM студенты);
END;
$$ LANGUAGE plpgsql;

-- Использование
SELECT средний_возраст();
```

---

## Уровень 13: Задачи

### Задача 13.1
Создайте функцию, возвращающую количество студентов.

**Команда для выполнения:**
```sql
CREATE OR REPLACE FUNCTION количество_студентов()
RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM студенты);
END;
$$ LANGUAGE plpgsql;

SELECT количество_студентов();
```

### Задача 13.2
Создайте функцию, принимающую город и возвращающую количество студентов в этом городе.

**Команда для выполнения:**
```sql
CREATE OR REPLACE FUNCTION студенты_в_городе(город_параметр VARCHAR)
RETURNS INTEGER AS $$
BEGIN
    RETURN (SELECT COUNT(*) FROM студенты WHERE город = город_параметр);
END;
$$ LANGUAGE plpgsql;

SELECT студенты_в_городе('Москва');
```

---

## Уровень 14: Триггеры

### Теория

**Триггер** - автоматически выполняемый код при определенных событиях.

**Создание триггера:**
```sql
CREATE OR REPLACE FUNCTION функция_триггера()
RETURNS TRIGGER AS $$
BEGIN
    -- код
    RETURN NEW;  -- или OLD
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER имя_триггера
BEFORE/AFTER INSERT/UPDATE/DELETE
ON таблица
FOR EACH ROW
EXECUTE FUNCTION функция_триггера();
```

**Пример - логирование изменений:**
```sql
CREATE TABLE логи (
    id SERIAL PRIMARY KEY,
    таблица VARCHAR(50),
    операция VARCHAR(10),
    время TIMESTAMP DEFAULT NOW()
);

CREATE OR REPLACE FUNCTION log_changes()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO логи (таблица, операция) 
    VALUES (TG_TABLE_NAME, TG_OP);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER log_students
AFTER INSERT OR UPDATE OR DELETE
ON студенты
FOR EACH ROW
EXECUTE FUNCTION log_changes();
```

---

## Уровень 15: Продвинутые задачи

### Задача 15.1
Создайте систему учета оценок студентов.

**Структура:**
- Таблица `предметы` (id, название)
- Таблица `оценки` (id, студент_id, предмет_id, оценка, дата)
- Выведите средний балл каждого студента

### Задача 15.2
Создайте систему управления библиотекой.

**Структура:**
- Таблица `книги` (id, название, автор)
- Таблица `читатели` (id, имя)
- Таблица `выдачи` (id, книга_id, читатель_id, дата_выдачи, дата_возврата)
- Найдите книги, которые не возвращены

### Задача 15.3
Создайте систему учета заказов.

**Структура:**
- Таблица `клиенты` (id, имя, email)
- Таблица `товары` (id, название, цена)
- Таблица `заказы` (id, клиент_id, дата)
- Таблица `заказ_товары` (заказ_id, товар_id, количество)
- Вычислите общую стоимость каждого заказа

---

## Советы по изучению:

1. **Практикуйтесь регулярно** - создавайте свои таблицы и экспериментируйте
2. **Изучайте планы выполнения** - используйте EXPLAIN для оптимизации
3. **Читайте документацию** - PostgreSQL имеет отличную документацию
4. **Используйте транзакции** - для безопасности данных
5. **Создавайте индексы** - для производительности больших таблиц

Удачи в изучении PostgreSQL! 🐘

