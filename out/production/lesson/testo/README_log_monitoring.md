# Система автоматического мониторинга логов

Этот проект содержит скрипты для настройки автоматической отправки детализированных отчетов о логах системы на email адрес.

## Компоненты системы

1. **Postfix** - почтовый сервер для отправки отчетов
2. **Logwatch** - утилита для анализа и генерации отчетов о логах
3. **Crontab** - планировщик задач для ежедневной отправки
4. **Bash скрипты** - автоматизация настройки и отправки

## Файлы проекта

- `setup_log_monitoring.sh` - основной скрипт настройки
- `setup_external_smtp.sh` - скрипт для настройки внешнего SMTP
- `main.cf` - конфигурация Postfix (создается автоматически)
- `cron.txt` - конфигурация планировщика (создается автоматически)
- `README_log_monitoring.md` - данная инструкция

## Быстрый старт

### 1. Базовая настройка

```bash
# Сделать скрипты исполняемыми
chmod +x setup_log_monitoring.sh setup_external_smtp.sh

# Запустить основной скрипт настройки
sudo ./setup_log_monitoring.sh
```

Скрипт запросит ваш email адрес и автоматически настроит:
- Установку необходимых пакетов
- Конфигурацию Postfix
- Настройку Logwatch для детализированных отчетов
- Создание скрипта отправки логов
- Настройку crontab для ежедневной отправки в 00:00
- Отправку тестового письма

### 2. Настройка внешнего SMTP (опционально)

Для отправки через Gmail, Yandex или Mail.ru:

```bash
sudo ./setup_external_smtp.sh
```

**Важно:** Используйте пароль приложения, а не обычный пароль!

#### Настройка паролей приложения:

**Gmail:**
1. Включите двухфакторную аутентификацию
2. Перейдите в "Безопасность" → "Пароли приложений"
3. Создайте новый пароль приложения

**Yandex:**
1. Включите двухфакторную аутентификацию
2. Перейдите в "Безопасность" → "Пароли приложений"
3. Создайте новый пароль приложения

**Mail.ru:**
1. Включите двухфакторную аутентификацию
2. Перейдите в "Безопасность" → "Пароли приложений"
3. Создайте новый пароль приложения

## Конфигурация

### Crontab (cron.txt)

```
# Ежедневная отправка логов в 00:00
0 0 * * * /usr/local/bin/send_daily_logs.sh
```

### Postfix (main.cf)

Основные настройки включают:
- TLS шифрование
- SASL аутентификация
- Настройки сети
- Поддержка внешних SMTP серверов

### Logwatch

Настроен для генерации детализированных HTML отчетов:
- Уровень детализации: High
- Формат: HTML
- Период: предыдущий день
- Все сервисы включены

## Структура отчетов

Ежедневные отчеты содержат:

### Системная информация
- Загрузка системы
- Использование дисков
- Сетевые интерфейсы
- Процессы

### Безопасность
- Попытки входа в систему
- SSH соединения
- Неудачные аутентификации
- Подозрительная активность

### Сетевые сервисы
- Apache/Nginx логи
- FTP соединения
- DNS запросы
- Сетевые порты

### Системные сервисы
- Cron задачи
- Системные сообщения
- Ошибки ядра
- Обновления пакетов

## Управление системой

### Проверка статуса

```bash
# Статус Postfix
sudo systemctl status postfix

# Просмотр crontab
sudo crontab -l

# Проверка логов отправки
sudo tail -f /var/log/logwatch_sender.log

# Тестовая отправка
sudo /usr/local/bin/send_daily_logs.sh
```

### Остановка мониторинга

```bash
# Удалить задачу из crontab
sudo crontab -e
# Удалить строку: 0 0 * * * /usr/local/bin/send_daily_logs.sh

# Остановить Postfix
sudo systemctl stop postfix
```

### Восстановление из резервной копии

```bash
# Восстановить конфигурацию Postfix
sudo cp /etc/postfix/main.cf.backup.* /etc/postfix/main.cf

# Восстановить конфигурацию Logwatch
sudo cp /etc/logwatch/conf/logwatch.conf.backup.* /etc/logwatch/conf/logwatch.conf
```

## Устранение неполадок

### Письма не отправляются

1. Проверьте статус Postfix:
   ```bash
   sudo systemctl status postfix
   ```

2. Проверьте логи Postfix:
   ```bash
   sudo tail -f /var/log/mail.log
   ```

3. Проверьте конфигурацию:
   ```bash
   sudo postconf -n
   ```

### Ошибки аутентификации

1. Убедитесь, что используется пароль приложения
2. Проверьте файл с паролем:
   ```bash
   sudo cat /etc/postfix/sasl_passwd
   ```

3. Пересоздайте хеш-файл:
   ```bash
   sudo postmap /etc/postfix/sasl_passwd
   ```

### Отчеты не генерируются

1. Проверьте права доступа к логам:
   ```bash
   sudo ls -la /var/log/
   ```

2. Запустите Logwatch вручную:
   ```bash
   sudo logwatch --detail High --range yesterday --format html --output stdout
   ```

## Безопасность

- Все конфигурационные файлы имеют резервные копии
- Файлы с паролями защищены правами 600
- Используется TLS шифрование для SMTP
- Проверка синтаксиса конфигурационных файлов

## Поддержка

При возникновении проблем:

1. Проверьте логи системы
2. Убедитесь в корректности email адреса
3. Проверьте настройки SMTP сервера
4. Убедитесь, что используется пароль приложения

## Лицензия

Данный проект распространяется под лицензией MIT.
