# üìö –ü–æ–¥—Ä–æ–±–Ω–æ–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ SQLB11 (Day 09)

## üéØ –í–í–ï–î–ï–ù–ò–ï

–≠—Ç–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞ SQLB11 (Day 09) –ø—Ä–æ —Ñ—É–Ω–∫—Ü–∏–∏, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏ —Ç—Ä–∏–≥–≥–µ—Ä—ã –≤ PostgreSQL. –ö–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ —Ä–∞–∑–±–∏—Ç–æ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è–º–∏.

**–í–∞–∂–Ω–æ:** –ü—Ä–æ–µ–∫—Ç –≤ –®–∫–æ–ª–µ 21 ‚Äî –ø—Ä–æ –ø–æ–Ω–∏–º–∞–Ω–∏–µ. –ù–µ –∫–æ–ø–∏—Ä—É–π —Å–ª–µ–ø–æ. –î–∞–∂–µ –µ—Å–ª–∏ –±–µ—Ä—ë—à—å —à–∞–±–ª–æ–Ω –∏–∑ –≥–∞–π–¥–∞ ‚Äî –ø–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å, –ø–æ—á–µ–º—É –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ –ø–æ–ø—Ä–æ–±—É–π –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–µ–±–µ –≤—Å–ª—É—Ö.

---

## 0) –ë—ã—Å—Ç—Ä—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç: –ø—Ä–æ —á—Ç–æ Day 09

Day 09 ‚Äî —ç—Ç–æ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑—É—á–µ–Ω–∏–µ **—Ñ—É–Ω–∫—Ü–∏–π, –ø—Ä–æ—Ü–µ–¥—É—Ä –∏ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤** –≤ PostgreSQL:

- **–§—É–Ω–∫—Ü–∏–∏ (Functions)** ‚Äî —ç—Ç–æ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ SQL-–∑–∞–ø—Ä–æ—Å–æ–≤. –ú–æ–≥—É—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ —Ç–∞–±–ª–∏—Ü—ã.
- **–¢—Ä–∏–≥–≥–µ—Ä—ã (Triggers)** ‚Äî —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö (INSERT, UPDATE, DELETE).
- **–ê—É–¥–∏—Ç (Audit)** ‚Äî —ç—Ç–æ –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è.

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏:**
1. **SQL-—Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –ø—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —á–∏—Å—Ç–æ–º SQL
2. **PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî —Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–º —è–∑—ã–∫–µ PostgreSQL
3. **–¢—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
4. **–ê—É–¥–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π** ‚Äî –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –¥–∞–Ω–Ω—ã–º–∏

---

## 1) –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ (–æ–¥–∏–Ω —Ä–∞–∑ –ø–µ—Ä–µ–¥ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏)

### 1.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –∫—É–¥–∞ –∫–ª–∞—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è

–ü–æ `README_RUS.md` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è —Ç—ã —Å–æ–∑–¥–∞—ë—à—å —Ñ–∞–π–ª —Å—Ç—Ä–æ–≥–æ –ø–æ —à–∞–±–ª–æ–Ω—É:

- `src/ex00/day09_ex00.sql`
- `src/ex01/day09_ex01.sql`
- ‚Ä¶
- `src/ex08/day09_ex08.sql`

**–í–∞–∂–Ω–æ:** –í –∫–∞–∂–¥–æ–º —Ñ–∞–π–ª–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å:
- SQL-–∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–æ–≤ (—Ç–∞–±–ª–∏—Ü, —Ñ—É–Ω–∫—Ü–∏–π, —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤)
- –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã

### 1.2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã–º–∏

–í `materials/model.sql` –æ–ø–∏—Å–∞–Ω–∞ –≤—Å—è —Å—Ö–µ–º–∞ –∏ –≤—Å—Ç–∞–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ. –ï–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —Ç–≤–æ–µ–π –±–∞–∑–µ PostgreSQL.

**–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ (—Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ –¥–ª—è Day09):**

- `person(id bigint, name varchar, age integer, gender varchar, address varchar)` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
- `pizzeria(id bigint, name varchar, rating numeric)` ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –ø–∏—Ü—Ü–µ—Ä–∏–π
- `menu(id bigint, pizzeria_id bigint, pizza_name varchar, price numeric)` ‚Äî –º–µ–Ω—é
- `person_visits(id bigint, person_id bigint, pizzeria_id bigint, visit_date date)` ‚Äî –≤–∏–∑–∏—Ç—ã
- `person_order(id bigint, person_id bigint, menu_id bigint, order_date date)` ‚Äî –∑–∞–∫–∞–∑—ã

### 1.3. –ú–∏–Ω–∏-—à–ø–∞—Ä–≥–∞–ª–∫–∞ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è_—Ñ—É–Ω–∫—Ü–∏–∏(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS —Ç–∏–ø_–≤–æ–∑–≤—Ä–∞—Ç–∞ AS $$
    SELECT ...;
$$ LANGUAGE SQL;
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è_—Ñ—É–Ω–∫—Ü–∏–∏(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS —Ç–∏–ø_–≤–æ–∑–≤—Ä–∞—Ç–∞ AS $$
BEGIN
    -- –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏
    RETURN ...;
END;
$$ LANGUAGE plpgsql;
```

3. **–°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–µ–π —Ç–∞–±–ª–∏—Ü—É:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è_—Ñ—É–Ω–∫—Ü–∏–∏(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS TABLE(–∫–æ–ª–æ–Ω–∫–∞1 —Ç–∏–ø1, –∫–æ–ª–æ–Ω–∫–∞2 —Ç–∏–ø2) AS $$
    -- –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏
$$ LANGUAGE plpgsql;
```

**–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:**

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è_—Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π_—Ñ—É–Ω–∫—Ü–∏–∏()
RETURNS TRIGGER AS $$
BEGIN
    -- –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏
    RETURN NEW; -- –∏–ª–∏ OLD, –∏–ª–∏ NULL
END;
$$ LANGUAGE plpgsql;
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞:**
```sql
CREATE TRIGGER –∏–º—è_—Ç—Ä–∏–≥–≥–µ—Ä–∞
    BEFORE/AFTER INSERT/UPDATE/DELETE
    ON —Ç–∞–±–ª–∏—Ü–∞
    FOR EACH ROW
    EXECUTE FUNCTION –∏–º—è_—Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π_—Ñ—É–Ω–∫—Ü–∏–∏();
```

**–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö:**
- `NEW` ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–¥–ª—è INSERT –∏ UPDATE)
- `OLD` ‚Äî —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ (–¥–ª—è UPDATE –∏ DELETE)
- `TG_OP` ‚Äî –æ–ø–µ—Ä–∞—Ü–∏—è ('INSERT', 'UPDATE', 'DELETE')

---

## üìù –ó–ê–î–ê–ù–ò–ï 00: Audit of incoming inserts

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π INSERT –≤ —Ç–∞–±–ª–∏—Ü–µ `person`.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**–ê—É–¥–∏—Ç (Audit):**
- –ú–µ—Ö–∞–Ω–∏–∑–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –æ—Ç—Å–ª–µ–¥–∏—Ç—å, –∫—Ç–æ, –∫–æ–≥–¥–∞ –∏ —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –æ—Ç–ª–∞–¥–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–¢—Ä–∏–≥–≥–µ—Ä—ã:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö
- `AFTER INSERT` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
- `FOR EACH ROW` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É person_audit

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ç–∞–±–ª–∏—Ü—É `person_audit` –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã `person`
2. –î–æ–±–∞–≤—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –∞—É–¥–∏—Ç–∞

```sql
CREATE TABLE person_audit (
    created timestamp with time zone NOT NULL DEFAULT current_timestamp,
    type_event char(1) NOT NULL DEFAULT 'I',
    row_id bigint NOT NULL,
    name varchar,
    age integer,
    gender varchar,
    address varchar,
    CONSTRAINT ch_type_event CHECK (type_event IN ('I', 'U', 'D'))
);
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `created` ‚Äî –≤—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–ø–∏—Å–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è)
- `type_event` ‚Äî —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è ('I' = Insert, 'U' = Update, 'D' = Delete)
- `row_id` ‚Äî –∫–æ–ø–∏—è `person.id`
- –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è ‚Äî –∫–æ–ø–∏–∏ –ø–æ–ª–µ–π –∏–∑ `person`

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–º –ø—Ä–∏ INSERT.

```sql
CREATE OR REPLACE FUNCTION fnc_trg_person_insert_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('I', NEW.id, NEW.name, NEW.age, NEW.gender, NEW.address);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `NEW` ‚Äî –Ω–æ–≤–∞—è –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
- `NEW.id`, `NEW.name` –∏ —Ç.–¥. ‚Äî –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª—è–º –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
- `RETURN NEW` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤)

### üîç –®–ê–ì 3: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–∏ INSERT.

```sql
CREATE TRIGGER trg_person_insert_audit
    AFTER INSERT
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_insert_audit();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `AFTER INSERT` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
- `ON person` ‚Äî –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ç–∞–±–ª–∏—Ü–µ `person`
- `FOR EACH ROW` ‚Äî –¥–ª—è –∫–∞–∂–¥–æ–π –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
- `EXECUTE FUNCTION` ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç –Ω–∞—à—É —Ñ—É–Ω–∫—Ü–∏—é

### üîç –®–ê–ì 4: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–ø–æ–ª–Ω–∏ INSERT –∏ –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –∑–∞–ø–∏—Å—å –ø–æ—è–≤–∏–ª–∞—Å—å –≤ `person_audit`.

```sql
INSERT INTO person(id, name, age, gender, address) 
VALUES (10, 'Damir', 22, 'male', 'Irkutsk');

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT * FROM person_audit;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–í —Ç–∞–±–ª–∏—Ü–µ `person_audit` –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å —Å:
- `type_event = 'I'`
- `row_id = 10`
- `name = 'Damir'`
- –∏ —Ç.–¥.

### ‚úçÔ∏è –®–ê–ì 5: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex00/day09_ex00.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 00: Audit of incoming inserts
-- ============================================

-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∞—É–¥–∏—Ç–∞
CREATE TABLE person_audit (
    created timestamp with time zone NOT NULL DEFAULT current_timestamp,
    type_event char(1) NOT NULL DEFAULT 'I',
    row_id bigint NOT NULL,
    name varchar,
    age integer,
    gender varchar,
    address varchar,
    CONSTRAINT ch_type_event CHECK (type_event IN ('I', 'U', 'D'))
);

-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
CREATE OR REPLACE FUNCTION fnc_trg_person_insert_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('I', NEW.id, NEW.name, NEW.age, NEW.gender, NEW.address);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞
CREATE TRIGGER trg_person_insert_audit
    AFTER INSERT
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_insert_audit();

-- –®–∞–≥ 4: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
INSERT INTO person(id, name, age, gender, address) 
VALUES (10, 'Damir', 22, 'male', 'Irkutsk');

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
SELECT * FROM person_audit;
```

### ‚úÖ –®–ê–ì 6: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex00/day09_ex00.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –¢–∞–±–ª–∏—Ü–∞ `person_audit` —Å–æ–∑–¥–∞–Ω–∞
   - –¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω –∏ –∞–∫—Ç–∏–≤–µ–Ω
   - –ü—Ä–∏ INSERT –≤ `person` –∑–∞–ø–∏—Å—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `person_audit`

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ó–∞–±—ã—Ç—å `RETURN NEW`** ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è** ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è, –ø–æ—Ç–æ–º —Ç—Ä–∏–≥–≥–µ—Ä
- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `BEFORE` –≤–º–µ—Å—Ç–æ `AFTER`** ‚Äî –¥–ª—è –∞—É–¥–∏—Ç–∞ –æ–±—ã—á–Ω–æ –Ω—É–∂–µ–Ω `AFTER`

---

## üìù –ó–ê–î–ê–ù–ò–ï 01: Audit of incoming updates

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–†–∞—Å—à–∏—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π UPDATE –≤ —Ç–∞–±–ª–∏—Ü–µ `person`.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**UPDATE –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö:**
- –ü—Ä–∏ UPDATE –¥–æ—Å—Ç—É–ø–Ω—ã –∏ `OLD` (—Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞), –∏ `NEW` (–Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
- –î–ª—è –∞—É–¥–∏—Ç–∞ –æ–±—ã—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º `OLD` (–ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ)
- `type_event = 'U'` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è UPDATE

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏.

```sql
CREATE OR REPLACE FUNCTION fnc_trg_person_update_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('U', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `OLD` ‚Äî —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ (–¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)
- –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∞—É–¥–∏—Ç
- `RETURN NEW` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–æ–∫—É

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è UPDATE

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ UPDATE.

```sql
CREATE TRIGGER trg_person_update_audit
    AFTER UPDATE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_update_audit();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `AFTER UPDATE` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- –û—Å—Ç–∞–ª—å–Ω–æ–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∑–∞–¥–∞–Ω–∏—é

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–ø–æ–ª–Ω–∏ UPDATE –∏ –ø—Ä–æ–≤–µ—Ä—å –∞—É–¥–∏—Ç.

```sql
UPDATE person SET name = 'Bulat' WHERE id = 10;
UPDATE person SET name = 'Damir' WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–í —Ç–∞–±–ª–∏—Ü–µ `person_audit` –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏ —Å `type_event = 'U'` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ UPDATE.

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex01/day09_ex01.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 01: Audit of incoming updates
-- ============================================

-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è UPDATE
CREATE OR REPLACE FUNCTION fnc_trg_person_update_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('U', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –¥–ª—è UPDATE
CREATE TRIGGER trg_person_update_audit
    AFTER UPDATE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_update_audit();

-- –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
UPDATE person SET name = 'Bulat' WHERE id = 10;
UPDATE person SET name = 'Damir' WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex01/day09_ex01.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –ü—Ä–∏ UPDATE –≤ `person` –∑–∞–ø–∏—Å—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `person_audit`
   - `type_event = 'U'`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (OLD)

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `NEW` –≤–º–µ—Å—Ç–æ `OLD`** ‚Äî –¥–ª—è –∞—É–¥–∏—Ç–∞ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **–ó–∞–±—ã—Ç—å `RETURN NEW`** ‚Äî —Ç—Ä–∏–≥–≥–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ

---

## üìù –ó–ê–î–ê–ù–ò–ï 02: Audit of incoming deletes

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–†–∞—Å—à–∏—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π DELETE –≤ —Ç–∞–±–ª–∏—Ü–µ `person`.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**DELETE –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö:**
- –ü—Ä–∏ DELETE –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ `OLD` (—É–¥–∞–ª—è–µ–º–∞—è —Å—Ç—Ä–æ–∫–∞)
- `NEW` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¥–ª—è DELETE
- `type_event = 'D'` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏–π
- `RETURN OLD` –∏–ª–∏ `RETURN NULL` (–æ–±—ã—á–Ω–æ `OLD`)

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è DELETE

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —É–¥–∞–ª—è–µ–º—É—é —Å—Ç—Ä–æ–∫—É.

```sql
CREATE OR REPLACE FUNCTION fnc_trg_person_delete_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('D', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `OLD` ‚Äî —É–¥–∞–ª—è–µ–º–∞—è —Å—Ç—Ä–æ–∫–∞
- –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—ë –≤ –∞—É–¥–∏—Ç –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
- `RETURN OLD` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–¥–∞–ª—è–µ–º—É—é —Å—Ç—Ä–æ–∫—É

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è DELETE

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ DELETE.

```sql
CREATE TRIGGER trg_person_delete_audit
    AFTER DELETE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_delete_audit();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `AFTER DELETE` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
- –û—Å—Ç–∞–ª—å–Ω–æ–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–∏–º –∑–∞–¥–∞–Ω–∏—è–º

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–ø–æ–ª–Ω–∏ DELETE –∏ –ø—Ä–æ–≤–µ—Ä—å –∞—É–¥–∏—Ç.

```sql
DELETE FROM person WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–í —Ç–∞–±–ª–∏—Ü–µ `person_audit` –¥–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å—å —Å `type_event = 'D'` –∏ –¥–∞–Ω–Ω—ã–º–∏ —É–¥–∞–ª—ë–Ω–Ω–æ–π —Å—Ç—Ä–æ–∫–∏.

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex02/day09_ex02.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 02: Audit of incoming deletes
-- ============================================

-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è DELETE
CREATE OR REPLACE FUNCTION fnc_trg_person_delete_audit()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
    VALUES ('D', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞ –¥–ª—è DELETE
CREATE TRIGGER trg_person_delete_audit
    AFTER DELETE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_delete_audit();

-- –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
DELETE FROM person WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex02/day09_ex02.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –ü—Ä–∏ DELETE –≤ `person` –∑–∞–ø–∏—Å—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ `person_audit`
   - `type_event = 'D'`
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —É–¥–∞–ª—ë–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ (OLD)

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `NEW` –≤–º–µ—Å—Ç–æ `OLD`** ‚Äî –ø—Ä–∏ DELETE `NEW` –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π RETURN** ‚Äî –¥–ª—è DELETE –æ–±—ã—á–Ω–æ `RETURN OLD`

---

## üìù –ó–ê–î–ê–ù–ò–ï 03: Generic Audit

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–û–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤—Å–µ —Ç—Ä–∏ —Ç—Ä–∏–≥–≥–µ—Ä–∞ (INSERT, UPDATE, DELETE) –≤ –æ–¥–∏–Ω —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä:**
- –û–¥–∏–Ω —Ç—Ä–∏–≥–≥–µ—Ä –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∏–ø–æ–≤ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ò—Å–ø–æ–ª—å–∑—É–µ–º `TG_OP` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
- –£–ø—Ä–æ—â–∞–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É –∫–æ–¥–∞

### üîç –®–ê–ì 1: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–£–¥–∞–ª–∏ —Ç—Ä–∏ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞ –∏ —Ç—Ä–∏ —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏.

```sql
-- –£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
DROP TRIGGER IF EXISTS trg_person_insert_audit ON person;
DROP TRIGGER IF EXISTS trg_person_update_audit ON person;
DROP TRIGGER IF EXISTS trg_person_delete_audit ON person;

-- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
DROP FUNCTION IF EXISTS fnc_trg_person_insert_audit();
DROP FUNCTION IF EXISTS fnc_trg_person_update_audit();
DROP FUNCTION IF EXISTS fnc_trg_person_delete_audit();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `IF EXISTS` ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ (–Ω–µ –æ—à–∏–±—ë—Ç—Å—è, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
- –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø–æ—Ç–æ–º —Ñ—É–Ω–∫—Ü–∏–∏

### üîç –®–ê–ì 2: –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∞—É–¥–∏—Ç–∞

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–û—á–∏—Å—Ç–∏ —Ç–∞–±–ª–∏—Ü—É `person_audit` –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

```sql
TRUNCATE TABLE person_audit;
-- –∏–ª–∏
-- DELETE FROM person_audit;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `TRUNCATE` ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
- `DELETE` ‚Äî –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WHERE

### üîç –®–ê–ì 3: –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ç—Ä–∏–≥–≥–µ—Ä–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç—Ä–∏ —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–π.

```sql
CREATE OR REPLACE FUNCTION fnc_trg_person_audit()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('I', NEW.id, NEW.name, NEW.age, NEW.gender, NEW.address);
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('U', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('D', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `TG_OP` ‚Äî —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è, —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ ('INSERT', 'UPDATE', 'DELETE')
- `IF-ELSIF-ELSE` ‚Äî —É—Å–ª–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–∞–∂–¥—ã–π –±–ª–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–≤–æ–π —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏

### üîç –®–ê–ì 4: –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ç—Ä–∏–≥–≥–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö.

```sql
CREATE TRIGGER trg_person_audit
    AFTER INSERT OR UPDATE OR DELETE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_audit();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `AFTER INSERT OR UPDATE OR DELETE` ‚Äî —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –≤—Å–µ—Ö —Ç—Ä—ë—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
- –û–¥–∏–Ω —Ç—Ä–∏–≥–≥–µ—Ä –≤–º–µ—Å—Ç–æ —Ç—Ä—ë—Ö!

### üîç –®–ê–ì 5: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–ø–æ–ª–Ω–∏ –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ—Ä—å –∞—É–¥–∏—Ç.

```sql
INSERT INTO person(id, name, age, gender, address) 
VALUES (10, 'Damir', 22, 'male', 'Irkutsk');

UPDATE person SET name = 'Bulat' WHERE id = 10;
UPDATE person SET name = 'Damir' WHERE id = 10;

DELETE FROM person WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–í —Ç–∞–±–ª–∏—Ü–µ `person_audit` –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –∑–∞–ø–∏—Å–∏:
- 1 –∑–∞–ø–∏—Å—å —Å `type_event = 'I'` (INSERT)
- 2 –∑–∞–ø–∏—Å–∏ —Å `type_event = 'U'` (UPDATE)
- 1 –∑–∞–ø–∏—Å—å —Å `type_event = 'D'` (DELETE)

### ‚úçÔ∏è –®–ê–ì 6: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex03/day09_ex03.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 03: Generic Audit
-- ============================================

-- –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
DROP TRIGGER IF EXISTS trg_person_insert_audit ON person;
DROP TRIGGER IF EXISTS trg_person_update_audit ON person;
DROP TRIGGER IF EXISTS trg_person_delete_audit ON person;

-- –®–∞–≥ 2: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
DROP FUNCTION IF EXISTS fnc_trg_person_insert_audit();
DROP FUNCTION IF EXISTS fnc_trg_person_update_audit();
DROP FUNCTION IF EXISTS fnc_trg_person_delete_audit();

-- –®–∞–≥ 3: –û—á–∏—Å—Ç–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –∞—É–¥–∏—Ç–∞
TRUNCATE TABLE person_audit;

-- –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
CREATE OR REPLACE FUNCTION fnc_trg_person_audit()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('I', NEW.id, NEW.name, NEW.age, NEW.gender, NEW.address);
        RETURN NEW;
    ELSIF TG_OP = 'UPDATE' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('U', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
        RETURN NEW;
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO person_audit (type_event, row_id, name, age, gender, address)
        VALUES ('D', OLD.id, OLD.name, OLD.age, OLD.gender, OLD.address);
        RETURN OLD;
    END IF;
    RETURN NULL;
END;
$$ LANGUAGE plpgsql;

-- –®–∞–≥ 5: –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞
CREATE TRIGGER trg_person_audit
    AFTER INSERT OR UPDATE OR DELETE
    ON person
    FOR EACH ROW
    EXECUTE FUNCTION fnc_trg_person_audit();

-- –®–∞–≥ 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
INSERT INTO person(id, name, age, gender, address) 
VALUES (10, 'Damir', 22, 'male', 'Irkutsk');

UPDATE person SET name = 'Bulat' WHERE id = 10;
UPDATE person SET name = 'Damir' WHERE id = 10;

DELETE FROM person WHERE id = 10;

-- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
SELECT * FROM person_audit WHERE row_id = 10 ORDER BY created;
```

### ‚úÖ –®–ê–ì 7: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex03/day09_ex03.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –°—Ç–∞—Ä—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã
   - –ù–æ–≤—ã–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –í—Å–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è** ‚Äî —Å–Ω–∞—á–∞–ª–∞ —Ç—Ä–∏–≥–≥–µ—Ä—ã, –ø–æ—Ç–æ–º —Ñ—É–Ω–∫—Ü–∏–∏
- **–ó–∞–±—ã—Ç—å –æ—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É –∞—É–¥–∏—Ç–∞** ‚Äî —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –º–µ—à–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ `TG_OP`** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 'INSERT', 'UPDATE', 'DELETE' (–∑–∞–≥–ª–∞–≤–Ω—ã–º–∏)

---

## üìù –ó–ê–î–ê–ù–ò–ï 04: Database View VS Database Function

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–º–µ–Ω—è—é—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è (views) –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –ø–æ–ª—É.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**SQL-—Ñ—É–Ω–∫—Ü–∏–∏ vs Views:**
- **Views** ‚Äî –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã, –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ
- **SQL-—Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –º–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—ã, –Ω–æ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–∞—Ü–∏–∏
- SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `FROM` –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã

**SQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
- –ü—Ä–æ—â–µ, —á–µ–º PL/pgSQL
- –í–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç SELECT-–∑–∞–ø—Ä–æ—Å–∞
- –ù–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—É—é –ª–æ–≥–∏–∫—É (IF, LOOP –∏ —Ç.–¥.)

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º—É–∂—á–∏–Ω

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π SQL-—Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö –º—É–∂—á–∏–Ω.

```sql
CREATE OR REPLACE FUNCTION fnc_persons_male()
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = 'male';
$$ LANGUAGE SQL;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `RETURNS TABLE` ‚Äî —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É
- –í —Å–∫–æ–±–∫–∞—Ö –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–∏–ø–∞–º–∏
- `$$ ... $$` ‚Äî —Ç–µ–ª–æ —Ñ—É–Ω–∫—Ü–∏–∏ (–æ–±—ã—á–Ω—ã–π SELECT)
- `LANGUAGE SQL` ‚Äî —ç—Ç–æ SQL-—Ñ—É–Ω–∫—Ü–∏—è, –Ω–µ PL/pgSQL

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –∂–µ–Ω—â–∏–Ω

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π SQL-—Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö –∂–µ–Ω—â–∏–Ω.

```sql
CREATE OR REPLACE FUNCTION fnc_persons_female()
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = 'female';
$$ LANGUAGE SQL;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Ñ—É–Ω–∫—Ü–∏–∏
- –¢–æ–ª—å–∫–æ —É—Å–ª–æ–≤–∏–µ `WHERE gender = 'female'`

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã.

```sql
-- –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º—É–∂—á–∏–Ω
SELECT * FROM fnc_persons_male();

-- –í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∂–µ–Ω—â–∏–Ω
SELECT * FROM fnc_persons_female();
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `fnc_persons_male()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –º—É–∂—á–∏–Ω
- `fnc_persons_female()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∂–µ–Ω—â–∏–Ω

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex04/day09_ex04.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 04: Database View VS Database Function
-- ============================================

-- –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º—É–∂—á–∏–Ω
CREATE OR REPLACE FUNCTION fnc_persons_male()
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = 'male';
$$ LANGUAGE SQL;

-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∂–µ–Ω—â–∏–Ω
CREATE OR REPLACE FUNCTION fnc_persons_female()
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = 'female';
$$ LANGUAGE SQL;

-- –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT * FROM fnc_persons_male();
SELECT * FROM fnc_persons_female();
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex04/day09_ex04.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –§—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã –∏ —Ä–∞–±–æ—Ç–∞—é—Ç
   - –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –∏—Ö –∫–∞–∫ —Ç–∞–±–ª–∏—Ü—ã
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `LANGUAGE plpgsql`** ‚Äî –∑–∞–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏–∏
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ `RETURNS TABLE`** ‚Äî –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–∏–ø–∞–º–∏
- **–ó–∞–±—ã—Ç—å —Å–∫–æ–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ** ‚Äî `fnc_persons_male()` –∞ –Ω–µ `fnc_persons_male`

---

## üìù –ó–ê–î–ê–ù–ò–ï 05: Parameterized Database Function

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é SQL-—Ñ—É–Ω–∫—Ü–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—É.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**–ü–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–¥–µ–ª–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π
- –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–ª–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º
- –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∏–ª–∏ –±–µ–∑ –Ω–µ–≥–æ

### üîç –®–ê–ì 1: –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–£–¥–∞–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.

```sql
DROP FUNCTION IF EXISTS fnc_persons_male();
DROP FUNCTION IF EXISTS fnc_persons_female();
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- –ó–∞–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–π

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π SQL-—Ñ—É–Ω–∫—Ü–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º `pgender`.

```sql
CREATE OR REPLACE FUNCTION fnc_persons(pgender varchar DEFAULT 'female')
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = pgender;
$$ LANGUAGE SQL;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `pgender varchar DEFAULT 'female'` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- –í WHERE –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä `pgender`
- –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è 'female'

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∏ –±–µ–∑ –Ω–µ–≥–æ.

```sql
-- –í—ã–∑–æ–≤ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
SELECT * FROM fnc_persons(pgender := 'male');

-- –í—ã–∑–æ–≤ –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'female')
SELECT * FROM fnc_persons();
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –° `pgender := 'male'` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –º—É–∂—á–∏–Ω—ã
- –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –∂–µ–Ω—â–∏–Ω—ã (–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex05/day09_ex05.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 05: Parameterized Database Function
-- ============================================

-- –®–∞–≥ 1: –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
DROP FUNCTION IF EXISTS fnc_persons_male();
DROP FUNCTION IF EXISTS fnc_persons_female();

-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏
CREATE OR REPLACE FUNCTION fnc_persons(pgender varchar DEFAULT 'female')
RETURNS TABLE (
    id bigint,
    name varchar,
    age integer,
    gender varchar,
    address varchar
) AS $$
    SELECT id, name, age, gender, address
    FROM person
    WHERE gender = pgender;
$$ LANGUAGE SQL;

-- –®–∞–≥ 3: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT * FROM fnc_persons(pgender := 'male');
SELECT * FROM fnc_persons();
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex05/day09_ex05.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –°—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω—ã
   - –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∏ –±–µ–∑ –Ω–µ–≥–æ
   - –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞** ‚Äî `pgender varchar DEFAULT 'female'`
- **–ó–∞–±—ã—Ç—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏** ‚Äî –∑–∞–¥–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç –∏—Ö —É–¥–∞–ª–µ–Ω–∏—è
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º** ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π `pgender := 'male'`

---

## üìù –ó–ê–î–ê–ù–ò–ï 06: Function like a function-wrapper

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç —Å–ª–æ–∂–Ω—ã–π SQL-–∑–∞–ø—Ä–æ—Å —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
- –ú–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—É—é –ª–æ–≥–∏–∫—É (IF, LOOP, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ)
- –ë–æ–ª–µ–µ –≥–∏–±–∫–∏–µ, —á–µ–º SQL-—Ñ—É–Ω–∫—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è —Å–ª–æ–∂–Ω–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏

**–ó–∞–¥–∞—á–∞ —Ñ—É–Ω–∫—Ü–∏–∏:**
–ù–∞–π—Ç–∏ –ø–∏—Ü—Ü–µ—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ:
1. –ü–æ—Å–µ—Ç–∏–ª —á–µ–ª–æ–≤–µ–∫ (–ø–∞—Ä–∞–º–µ—Ç—Ä `pperson`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 'Dmitriy')
2. –ì–¥–µ –º–æ–∂–Ω–æ –∫—É–ø–∏—Ç—å –ø–∏—Ü—Ü—É –¥–µ—à–µ–≤–ª–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Å—É–º–º—ã (–ø–∞—Ä–∞–º–µ—Ç—Ä `pprice`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 500)
3. –ù–∞ –∑–∞–¥–∞–Ω–Ω—É—é –¥–∞—Ç—É (–ø–∞—Ä–∞–º–µ—Ç—Ä `pdate`, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é '2022-01-08')

### üîç –®–ê–ì 1: –ü–æ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–ø—Ä–æ—Å–∞

**–ß—Ç–æ –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏:**
- –ü–∏—Ü—Ü–µ—Ä–∏–∏ –∏–∑ `person_visits` (–≥–¥–µ —á–µ–ª–æ–≤–µ–∫ –±—ã–ª)
- –ò –∏–∑ `menu` (–≥–¥–µ –µ—Å—Ç—å –ø–∏—Ü—Ü–∞ –¥–µ—à–µ–≤–ª–µ `pprice`)
- –ù–∞ –¥–∞—Ç—É `pdate`

**–°–≤—è–∑–∏:**
- `person_visits.person_id -> person.id` (–ø–æ –∏–º–µ–Ω–∏)
- `person_visits.pizzeria_id -> pizzeria.id`
- `menu.pizzeria_id -> pizzeria.id`
- `menu.price < pprice`

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–°–æ–∑–¥–∞–π —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∏—Ü—Ü–µ—Ä–∏–π.

```sql
CREATE OR REPLACE FUNCTION fnc_person_visits_and_eats_on_date(
    pperson varchar DEFAULT 'Dmitriy',
    pprice numeric DEFAULT 500,
    pdate date DEFAULT '2022-01-08'
)
RETURNS TABLE (pizzeria_name varchar) AS $$
BEGIN
    RETURN QUERY
    SELECT DISTINCT pz.name
    FROM person_visits pv
    JOIN person p ON p.id = pv.person_id
    JOIN pizzeria pz ON pz.id = pv.pizzeria_id
    JOIN menu m ON m.pizzeria_id = pz.id
    WHERE p.name = pperson
      AND pv.visit_date = pdate
      AND m.price < pprice;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `pperson`, `pprice`, `pdate` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- `RETURNS TABLE (pizzeria_name varchar)` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É —Å –æ–¥–Ω–æ–π –∫–æ–ª–æ–Ω–∫–æ–π
- `RETURN QUERY` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç SELECT-–∑–∞–ø—Ä–æ—Å–∞
- `DISTINCT` ‚Äî —É–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –≤ –ø–∏—Ü—Ü–µ—Ä–∏–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–∏—Ü—Ü –¥–µ—à–µ–≤–ª–µ —Ü–µ–Ω—ã)
- `LANGUAGE plpgsql` ‚Äî —ç—Ç–æ PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏—è

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

```sql
-- –í—ã–∑–æ–≤ —Å –æ–¥–Ω–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
SELECT * FROM fnc_person_visits_and_eats_on_date(pprice := 800);

-- –í—ã–∑–æ–≤ —Å–æ –≤—Å–µ–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
SELECT * FROM fnc_person_visits_and_eats_on_date(
    pperson := 'Anna', 
    pprice := 1300, 
    pdate := '2022-01-01'
);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–§—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∏—Ü—Ü–µ—Ä–∏–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç —É—Å–ª–æ–≤–∏—è–º.

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex06/day09_ex06.sql`:**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 06: Function like a function-wrapper
-- ============================================

-- –°–æ–∑–¥–∞–Ω–∏–µ PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏
CREATE OR REPLACE FUNCTION fnc_person_visits_and_eats_on_date(
    pperson varchar DEFAULT 'Dmitriy',
    pprice numeric DEFAULT 500,
    pdate date DEFAULT '2022-01-08'
)
RETURNS TABLE (pizzeria_name varchar) AS $$
BEGIN
    RETURN QUERY
    SELECT DISTINCT pz.name
    FROM person_visits pv
    JOIN person p ON p.id = pv.person_id
    JOIN pizzeria pz ON pz.id = pv.pizzeria_id
    JOIN menu m ON m.pizzeria_id = pz.id
    WHERE p.name = pperson
      AND pv.visit_date = pdate
      AND m.price < pprice;
END;
$$ LANGUAGE plpgsql;

-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT * FROM fnc_person_visits_and_eats_on_date(pprice := 800);
SELECT * FROM fnc_person_visits_and_eats_on_date(
    pperson := 'Anna', 
    pprice := 1300, 
    pdate := '2022-01-01'
);
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex06/day09_ex06.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞—é—Ç
   - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π JOIN** ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–≤—è–∑–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
- **–ó–∞–±—ã—Ç—å `DISTINCT`** ‚Äî –º–æ–≥—É—Ç –±—ã—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–∏–ø –≤–æ–∑–≤—Ä–∞—Ç–∞** ‚Äî `RETURNS TABLE`, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ `RETURNS varchar`

---

## üìù –ó–ê–î–ê–ù–ò–ï 07: Different view to find a Minimum

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤–µ —á–∏—Å–µ–ª.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**–ú–∞—Å—Å–∏–≤—ã –≤ PostgreSQL:**
- PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤—ã —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤
- `ARRAY[10.0, -1.0, 5.0, 4.4]` ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞
- `VARIADIC` ‚Äî –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

**VARIADIC –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–∞—Å—Å–∏–≤ –∫–∞–∫ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
- `func_minimum(VARIADIC arr => ARRAY[10.0, -1.0, 5.0, 4.4])`
- –í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ `arr` ‚Äî —ç—Ç–æ –º–∞—Å—Å–∏–≤

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏–º—É–º–∞ (SQL)

**–í–∞—Ä–∏–∞–Ω—Ç 1: SQL-—Ñ—É–Ω–∫—Ü–∏—è**

```sql
CREATE OR REPLACE FUNCTION func_minimum(VARIADIC arr numeric[])
RETURNS numeric AS $$
    SELECT MIN(unnested_value)
    FROM UNNEST(arr) AS unnested_value;
$$ LANGUAGE SQL;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `VARIADIC arr numeric[]` ‚Äî –º–∞—Å—Å–∏–≤ —á–∏—Å–µ–ª
- `UNNEST(arr)` ‚Äî —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –º–∞—Å—Å–∏–≤ –≤ —Å—Ç—Ä–æ–∫–∏
- `MIN()` ‚Äî –Ω–∞—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏–º—É–º–∞ (PL/pgSQL)

**–í–∞—Ä–∏–∞–Ω—Ç 2: PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏—è**

```sql
CREATE OR REPLACE FUNCTION func_minimum(VARIADIC arr numeric[])
RETURNS numeric AS $$
DECLARE
    min_val numeric;
    i integer;
BEGIN
    min_val := arr[1];
    FOR i IN 2..array_length(arr, 1) LOOP
        IF arr[i] < min_val THEN
            min_val := arr[i];
        END IF;
    END LOOP;
    RETURN min_val;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `DECLARE` ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `FOR ... LOOP` ‚Äî —Ü–∏–∫–ª –ø–æ –º–∞—Å—Å–∏–≤—É
- `array_length(arr, 1)` ‚Äî –¥–ª–∏–Ω–∞ –º–∞—Å—Å–∏–≤–∞

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å –º–∞—Å—Å–∏–≤–æ–º.

```sql
SELECT func_minimum(VARIADIC arr => ARRAY[10.0, -1.0, 5.0, 4.4]);
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
–î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å—Å—è `-1.0` (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ).

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex07/day09_ex07.sql` (SQL-–≤–∞—Ä–∏–∞–Ω—Ç):**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 07: Different view to find a Minimum
-- ============================================

-- SQL-–≤–∞—Ä–∏–∞–Ω—Ç (–ø—Ä–æ—â–µ)
CREATE OR REPLACE FUNCTION func_minimum(VARIADIC arr numeric[])
RETURNS numeric AS $$
    SELECT MIN(unnested_value)
    FROM UNNEST(arr) AS unnested_value;
$$ LANGUAGE SQL;

-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT func_minimum(VARIADIC arr => ARRAY[10.0, -1.0, 5.0, 4.4]);
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (PL/pgSQL):**

```sql
-- PL/pgSQL-–≤–∞—Ä–∏–∞–Ω—Ç (–±–æ–ª–µ–µ –≥–∏–±–∫–∏–π)
CREATE OR REPLACE FUNCTION func_minimum(VARIADIC arr numeric[])
RETURNS numeric AS $$
DECLARE
    min_val numeric;
    i integer;
BEGIN
    IF array_length(arr, 1) IS NULL THEN
        RETURN NULL;
    END IF;
    
    min_val := arr[1];
    FOR i IN 2..array_length(arr, 1) LOOP
        IF arr[i] < min_val THEN
            min_val := arr[i];
        END IF;
    END LOOP;
    RETURN min_val;
END;
$$ LANGUAGE plpgsql;
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex07/day09_ex07.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –§—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –º–∞—Å—Å–∏–≤–æ–º
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å VARIADIC** ‚Äî –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `VARIADIC arr numeric[]`
- **–ó–∞–±—ã—Ç—å UNNEST** ‚Äî –¥–ª—è SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤
- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞** ‚Äî –¥–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ NULL

---

## üìù –ó–ê–î–ê–ù–ò–ï 08: Fibonacci algorithm is in a function

### üéØ –¶–µ–ª—å –∑–∞–¥–∞–Ω–∏—è

–°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —á–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–µ–¥–µ–ª–∞.

### üìñ –ß—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–Ω—è—Ç—å

**–ß–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏:**
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 0, 1, 1, 2, 3, 5, 8, 13, 21, ...
- –ö–∞–∂–¥–æ–µ —á–∏—Å–ª–æ = —Å—É–º–º–∞ –¥–≤—É—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö
- F(0) = 0, F(1) = 1, F(n) = F(n-1) + F(n-2)

**–ó–∞–¥–∞—á–∞:**
–í–µ—Ä–Ω—É—Ç—å –≤—Å–µ —á–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏, –∫–æ—Ç–æ—Ä—ã–µ **–º–µ–Ω—å—à–µ** `pstop` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10).

### üîç –®–ê–ì 1: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é (SQL-–≤–∞—Ä–∏–∞–Ω—Ç —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π)

**–í–∞—Ä–∏–∞–Ω—Ç 1: –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE**

```sql
CREATE OR REPLACE FUNCTION fnc_fibonacci(pstop integer DEFAULT 10)
RETURNS TABLE (fibonacci_number bigint) AS $$
    WITH RECURSIVE fib(a, b) AS (
        SELECT 0::bigint, 1::bigint
        UNION ALL
        SELECT b, a + b
        FROM fib
        WHERE b < pstop
    )
    SELECT a FROM fib WHERE a < pstop;
$$ LANGUAGE SQL;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `WITH RECURSIVE` ‚Äî —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE
- `a, b` ‚Äî –¥–≤–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —á–∏—Å–ª–∞ –§–∏–±–æ–Ω–∞—á—á–∏
- –ù–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: `a=0, b=1`
- –†–µ–∫—É—Ä—Å–∏—è: `a=b, b=a+b`
- –£—Å–ª–æ–≤–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: `b < pstop`
- –í–æ–∑–≤—Ä–∞—â–∞–µ–º `a`, –≥–¥–µ `a < pstop`

### üîç –®–ê–ì 2: –°–æ–∑–¥–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é (PL/pgSQL-–≤–∞—Ä–∏–∞–Ω—Ç)

**–í–∞—Ä–∏–∞–Ω—Ç 2: PL/pgSQL —Å —Ü–∏–∫–ª–æ–º**

```sql
CREATE OR REPLACE FUNCTION fnc_fibonacci(pstop integer DEFAULT 10)
RETURNS TABLE (fibonacci_number bigint) AS $$
DECLARE
    a bigint := 0;
    b bigint := 1;
    temp bigint;
BEGIN
    -- –í–æ–∑–≤—Ä–∞—â–∞–µ–º 0, –µ—Å–ª–∏ pstop > 0
    IF pstop > 0 THEN
        RETURN QUERY SELECT a;
    END IF;
    
    -- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞
    WHILE b < pstop LOOP
        RETURN QUERY SELECT b;
        temp := a + b;
        a := b;
        b := temp;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

**–û–±—ä—è—Å–Ω–µ–Ω–∏–µ:**
- `DECLARE` ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- `WHILE ... LOOP` ‚Äî —Ü–∏–∫–ª, –ø–æ–∫–∞ `b < pstop`
- `RETURN QUERY` ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∂–¥–æ–µ —á–∏—Å–ª–æ
- –û–±–Ω–æ–≤–ª—è–µ–º `a` –∏ `b` –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏

### üîç –®–ê–ì 3: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
–í—ã–∑–æ–≤–∏ —Ñ—É–Ω–∫—Ü–∏—é —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

```sql
-- –° –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
SELECT * FROM fnc_fibonacci(100);

-- –ë–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 10)
SELECT * FROM fnc_fibonacci();
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- `fnc_fibonacci(100)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0, 1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89
- `fnc_fibonacci()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0, 1, 1, 2, 3, 5, 8

### ‚úçÔ∏è –®–ê–ì 4: –ù–∞–ø–∏—à–∏ —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–∞ `src/ex08/day09_ex08.sql` (SQL-–≤–∞—Ä–∏–∞–Ω—Ç):**

```sql
-- ============================================
-- –ó–∞–¥–∞–Ω–∏–µ 08: Fibonacci algorithm is in a function
-- ============================================

-- SQL-–≤–∞—Ä–∏–∞–Ω—Ç —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π
CREATE OR REPLACE FUNCTION fnc_fibonacci(pstop integer DEFAULT 10)
RETURNS TABLE (fibonacci_number bigint) AS $$
    WITH RECURSIVE fib(a, b) AS (
        SELECT 0::bigint, 1::bigint
        UNION ALL
        SELECT b, a + b
        FROM fib
        WHERE b < pstop
    )
    SELECT a FROM fib WHERE a < pstop;
$$ LANGUAGE SQL;

-- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
SELECT * FROM fnc_fibonacci(100);
SELECT * FROM fnc_fibonacci();
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (PL/pgSQL):**

```sql
-- PL/pgSQL-–≤–∞—Ä–∏–∞–Ω—Ç
CREATE OR REPLACE FUNCTION fnc_fibonacci(pstop integer DEFAULT 10)
RETURNS TABLE (fibonacci_number bigint) AS $$
DECLARE
    a bigint := 0;
    b bigint := 1;
    temp bigint;
BEGIN
    IF pstop > 0 THEN
        RETURN QUERY SELECT a;
    END IF;
    
    WHILE b < pstop LOOP
        RETURN QUERY SELECT b;
        temp := a + b;
        a := b;
        b := temp;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

### ‚úÖ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å:**
1. –°–æ–∑–¥–∞–π —Ñ–∞–π–ª `src/ex08/day09_ex08.sql`
2. –í—ã–ø–æ–ª–Ω–∏ –∫–æ–º–∞–Ω–¥—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
3. –£–±–µ–¥–∏—Å—å, —á—Ç–æ:
   - –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –í—Å–µ —á–∏—Å–ª–∞ –º–µ–Ω—å—à–µ `pstop`
   - –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

- **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ä–µ–∫—É—Ä—Å–∏—è** ‚Äî –Ω—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å `a` –∏ `b`
- **–í–∫–ª—é—á–∏—Ç—å —á–∏—Å–ª–æ, —Ä–∞–≤–Ω–æ–µ `pstop`** ‚Äî –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ **–º–µ–Ω—å—à–µ** `pstop`
- **–ó–∞–±—ã—Ç—å –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ 0** ‚Äî –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –®–ü–ê–†–ì–ê–õ–ö–ê

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π:

1. **–°–æ–∑–¥–∞–Ω–∏–µ SQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS —Ç–∏–ø AS $$
    SELECT ...;
$$ LANGUAGE SQL;
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS —Ç–∏–ø AS $$
BEGIN
    -- –∫–æ–¥
    RETURN ...;
END;
$$ LANGUAGE plpgsql;
```

3. **–§—É–Ω–∫—Ü–∏—è, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∞—è —Ç–∞–±–ª–∏—Ü—É:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è(–ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
RETURNS TABLE (–∫–æ–ª–æ–Ω–∫–∞ —Ç–∏–ø, ...) AS $$
    -- –∫–æ–¥
$$ LANGUAGE plpgsql;
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤:

1. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:**
```sql
CREATE OR REPLACE FUNCTION –∏–º—è_—Ñ—É–Ω–∫—Ü–∏–∏()
RETURNS TRIGGER AS $$
BEGIN
    -- –∫–æ–¥
    RETURN NEW; -- –∏–ª–∏ OLD
END;
$$ LANGUAGE plpgsql;
```

2. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä–∞:**
```sql
CREATE TRIGGER –∏–º—è_—Ç—Ä–∏–≥–≥–µ—Ä–∞
    AFTER INSERT OR UPDATE OR DELETE
    ON —Ç–∞–±–ª–∏—Ü–∞
    FOR EACH ROW
    EXECUTE FUNCTION –∏–º—è_—Ñ—É–Ω–∫—Ü–∏–∏();
```

### –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç—Ä–∏–≥–≥–µ—Ä–∞—Ö:

- `NEW` ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (INSERT, UPDATE)
- `OLD` ‚Äî —Å—Ç–∞—Ä–∞—è —Å—Ç—Ä–æ–∫–∞ (UPDATE, DELETE)
- `TG_OP` ‚Äî —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ ('INSERT', 'UPDATE', 'DELETE')

### –¢–∏–ø–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏ –∏ —Ä–µ—à–µ–Ω–∏—è:

1. **–ó–∞–±—ã–ª `RETURN NEW/OLD` –≤ —Ç—Ä–∏–≥–≥–µ—Ä–µ:**
   - –¢—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ
   - –î–ª—è INSERT/UPDATE –æ–±—ã—á–Ω–æ `RETURN NEW`
   - –î–ª—è DELETE –æ–±—ã—á–Ω–æ `RETURN OLD`

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ–∑–¥–∞–Ω–∏—è:**
   - –°–Ω–∞—á–∞–ª–∞ —Ñ—É–Ω–∫—Ü–∏—è, –ø–æ—Ç–æ–º —Ç—Ä–∏–≥–≥–µ—Ä
   - –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: —Å–Ω–∞—á–∞–ª–∞ —Ç—Ä–∏–≥–≥–µ—Ä, –ø–æ—Ç–æ–º —Ñ—É–Ω–∫—Ü–∏—è

3. **SQL vs PL/pgSQL:**
   - SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ—â–µ, –Ω–æ –Ω–µ –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ—Ü–µ–¥—É—Ä–Ω—É—é –ª–æ–≥–∏–∫—É
   - PL/pgSQL-—Ñ—É–Ω–∫—Ü–∏–∏ –≥–∏–±—á–µ, –Ω–æ —Å–ª–æ–∂–Ω–µ–µ

4. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π:**
   - `–ø–∞—Ä–∞–º–µ—Ç—Ä —Ç–∏–ø DEFAULT –∑–Ω–∞—á–µ–Ω–∏–µ` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
   - `VARIADIC arr —Ç–∏–ø[]` ‚Äî –º–∞—Å—Å–∏–≤ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è:

- ‚úÖ –§—É–Ω–∫—Ü–∏—è/—Ç—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞—é—Ç (–µ—Å–ª–∏ –µ—Å—Ç—å)
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
- ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
- ‚úÖ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ SQL-—Ñ–∞–π–ª–µ –æ–±—ä—è—Å–Ω—è—é—Ç –∫–∞–∂–¥—ã–π —à–∞–≥

---

## üöÄ –£–¥–∞—á–∏ –≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞!

–ü–æ–º–Ω–∏:
- –ß–∏—Ç–∞–π –∑–∞–¥–∞–Ω–∏—è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ
- –°–ª–µ–¥—É–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —à–∞–≥–æ–≤
- –¢–µ—Å—Ç–∏—Ä—É–π –∫–∞–∂–¥—É—é —Ñ—É–Ω–∫—Ü–∏—é/—Ç—Ä–∏–≥–≥–µ—Ä
- –ü–æ–Ω–∏–º–∞–π, –ø–æ—á–µ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥–∞—è –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
- –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π —Å —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–¥—Ö–æ–¥–∞–º–∏
- –ù–µ –±–æ–π—Å—è –æ—à–∏–±–æ–∫ ‚Äî –æ–Ω–∏ —á–∞—Å—Ç—å –æ–±—É—á–µ–Ω–∏—è!

